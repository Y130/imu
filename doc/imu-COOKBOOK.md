# The *imu* Cookbook
|                 | Points of Interest                                         |
|-----------------|------------------------------------------------------------|
|                 | **imu**                                                    |
| doc/            | Documentation and licensing information.                   |
| tup/            | Code modules called by *imu* at build-time.                |
| Tupfile.lua     | Launches *imu* when `tup` is executed. [(tup manual)][1]   |
| build-debug/    | DEBUG build artifacts and binaries.                        |
| build-release/  | RELEASE build artifacts and binaries.                      |
| build-*/bin/    | The finished product is placed here, ready to use.         |
| build-*/tmp/    | Intermediate files generated during compilation.           |
|                 |                                                            |
|                 | **Project Source**                                         |
| src/app/        | Contains the front-end code.                               |
| src/app/lib     | *imu*-provided CSS and JS libraries.                       |
| src/app/static/ | External assets to be used with all apps.                  |
| src/srv/        | Contains the back-end code.                                |
|                 |                                                            |
|                 | **nginx**                                                  |
| ssl/            | SSL certificates and keys used by project.                 |
| ngx/            | nginx configuration fragments, included by `ngx.conf`.     |
| .ngx/           | nginx temp directory, typically owned by root.             |
| .ngx/error.log  | Log file generated by nginx.                               |
| ngx.conf        | The nginx configuration file loaded by `web.sh`.           |
|                 |                                                            |
|                 | **imu Scripts**                                            |
| cleah.sh        | Deletes all *imu* temp files and build artifacts.          |
| swap.sh         | Swap symlink `./run` between build-debug/bin and release/. |
| new.sh "name"   | Creates an app template named "name".                      |
| ssl.sh "name"   | Makes needed SSL files, optionally a CSR & key for "name". |
| web.sh "signal" | 'start', 'stop', 'quit', 'reload' or 'reopen' the server.  |

[1]: http://gittup.org/tup/manual.html

## Creating Applications
*imu* assembles and combines the project structure described above into a single
HTML file and a project-shared `app/static/` directory.

You may create as many applications as needed for the project:

``` Shell
./new.sh "project name"
```

This will escape all non-alphanumeric characters in the project name with
underscores, then create empty skeleton files in `app/`.

|                   | Application Structure                                      |
|-------------------|------------------------------------------------------------|
| example/inline/   | SVG assets to be inlined with app.                         |
| example/\*.html   | Component templates.                                       |
| example/\*.js     | Component code.                                            |
| example-meta.html | HEAD metadata for Example.                                 |
| example.html      | Main application template.                                 |
| example.js        | Entry-point into the Example application.                  |
| example.scss      | Entry-point into Example's style.                          |

The app subdirectory is where each UI component making up the application is
placed. How these components are named are up to you.

The SCSS file is where Bulma is included into the application. This is the place
to make overrides or include additional CSS compoents into your app.

The JS file is where Vue.js is included into the application. It is the entry
point into the app's execution. All other libraries will also be referenced
here.

CSS and JS libraries should be placed in `app/lib/`. Typically you should
only be adding and upgrading files here. See below for details on upgrading
the provided libraries.

Most of *imu*'s logic lives in `Tupfile.lua` in the root. You may customize
this to suit your application needs as it grows. Place your intermediate build
artifacts in `tmp/`. Stage your final binaries into `bin/app/` and `bin/srv/`,
as appropriate.

##### nginx Configuration Generation & Lua Structure
By default, `tup` will generate simple `nginx` configuration files from the
contents of `srv/`. It will be placed in `bin/srv/`.

Using the filename of each `.lua` file found, a corresponding `.conf` file
is created with the same name.

The `.conf` has a single handle listening for `/filename`, which is directed to
`filename.lua`. This does assume that your Lua module will:

1. Assume a prefix for its URL routes (i.e. /someprefix/do/something)
2. Use its filename for the prefix (i.e. someprefix.lua)

This approach allows the ad-hoc insertion of Lua-backed URI namespaces into any
application `nginx` is serving, regardless of implementation. You simply
include the `.conf` into your existing `server` block for the application.

As *imu* emphasizes an API-focused approach for back-end code, it is typical to
structure things such as external API access and front-end application support
into their own modules and URI namespaces.

##### Swapping Builds
The default `ngx.conf` settings are set to load your apps from `./run/app`.
The Lua backend is loaded from `./run/srv`. To ease in testing, you can
swap between the DEBUG and RELEASE builds of your project by using `./swap.sh`.

It takes no arguments and will always properly set up a new `./run` for you.

##### Keeping Clean
The `clean.sh` script removes build artifacts. This is only a required step
when *imu*-based projects are distributed with build artifacts. You will not
need to execute `clean.sh` prior to `tup` in normal operation.

`tup` will refuse to clobber build artifacts that it did not generate. As a
checkout of the project will also be a new `tup` instance, these stale artifacts
must be removed.

This script may need updating if you are including build artifacts in your
repository and wish to avoid removing them.

Including a `--release` flag will also move `build-release/bin/` to `./run`,
ready for `nginx` to serve directly.

##### Setting It Up
You have two provided ways of building an *imu* project, `build-debug` or
`build-release`. The former is used for development and has almost all of
the optimization passes turned off. You may use `tup build-debug`, for
example, to build the DEBUG profile quickly. Using simply `tup` will build
both of these options.

While you are not required to use this convention, typically `./run`
is a symlink to the active build profile you wish nginx to serve, such
as `./build-debug/bin`. This is useful when testing for issues related to
optimization passes, as it is easy to swap. There is a `./swap.sh` script
provided for this very task. Simply run it and it will toggle between
DEBUG and RELEASE for you!

The simplest way of running the project is to cutomize the provided
`ngx.conf` and use `web.sh` to launch `nginx` with the project directory
as the root. Prior to running `nginx` for the first time, execute `./ssl.sh` to
generate the required encryption-related files. A first run would resemble:

``` Shell
tup build-debug
./swap.sh
./ssl.sh
./web.sh start
```

You may also use signals such as `./web.sh quit` and `./web.sh reload` to
control the `nginx` instance.

`./ssl.sh` can also generate SSL certificate requests and keys for you by
providing it with an argument. Use the form 'www.domain.com' or
'wild.domain.com' if requesting a wildcard certificate. The generated files
will be placed in `ssl/`. You will be prompted to enter values for the
certificate request.

In situations where there is an existing `/etc/nginx` and sites being served,
copy the `srv/` directory into it. The `app/` directory contents should then
be placed where it will be served by `nginx`.

Refer to `ngx.conf` for a configuration example to build off of.

##### Editor Support
Integration with editors is as trivial as executing `tup` anywhere in the
project tree.

##### Updating
It is not expected nor encouraged to directly track the *imu* tree beneath your
own application, as project needs and Tupfiles typically diverge. However, you
will want to track changes to the included libraries, which can be accomplished
with a few shell commands.

###### Updating Bulma
(from the *imu* root directory)

``` Shell
rm -rf src/app/lib/bulma
git clone --depth 1 https://github.com/jgthms/bulma src/app/lib/bulma
tup
```

Future updates may be then performed via `git pull` followed by `tup`. You may
need to update *imu*'s `.gitignore` to keep tidy.

###### Updating Vue.js
You will need to provide ES6-compliant module versions of Vue's libraries. This
can be accomplished by checking each library out and modifying the build script
to emit ES6 modules.

### Questions & Other Issues
##### nginx: [alert] could not open error log file
These messages are logged to `error.log` when `web.sh` is used. `nginx` uses a
hard-coded log path prior to parsing its configuration. These messages may
safely be ignored.

##### Have you considered building single-file components?
Yes! They are a neat idea, however `tup` does not detect when the extracted
files from a single `.vue` file are identical. This means changing a single
line of your template will also trigger a JavaScript rebuild, for example.

As the main advantage `tup` is avoiding work with large projects, this will
not work for *imu*.

If you wish to implement this yourself, these fragments may help:

``` Shell
# Extract <template meta> sections.
awk '/<template meta>/{a=1;next}/<\/template>/{a=0}a' %f > %o

# Extract the main <template>.
awk '/<template>/{a=1;next}/<\/template>/{a=0}a' %f > %o

# Extract <template id="*"> sections.
awk '/<template id=".*">/{a=1}/<\/template>/{print;a=0}a' %f > %o

# Extract <script> sections.
awk '/<script>/{a=1;next}/<\/script>/{a=0}a' %f > %o

# Extract <style> sections.
awk '/<style>/{a=1;next}/<\/style>/{a=0}a' %f > %o
```
